<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">

<HTML><HEAD><TITLE>RandomNumbers</TITLE>
<META name=GENERATOR content="My Notes Center 1.2 RC-7 (build 952)">

<STYLE> <!--
  body { font-family: Arial; font-size: 12pt }
-->
</STYLE>
</HEAD>
<BODY>
<DIV>&nbsp;</DIV>
<DIV><B><U>Shared random numbers in the master/slave framework</B></U></DIV>
<DIV>&nbsp;</B></U></DIV>
<DIV>The master/slave framework has a facility for generating pseudo-random numbers that is meant to be independent of whether it is called on a master or a slave.&nbsp;  However, it is possible to use it in such a way that the random number sequences get out of sync for brief periods.&nbsp;  This note describes its behavior and makes suggestions about how to avoid such errors.&nbsp;  Please note that the framework will also detect such errors and print an error message to the console if they occur.</DIV>
<DIV>&nbsp;</DIV>
<DIV>The following relevant data are transmitted from the master to the slaves on each frame:</DIV>
<DIV>&nbsp;</DIV>
<DIV>1)&nbsp;The current value of the random number seed. (_randomSeed)</DIV>
<DIV style="margin-left: 10px; text-indent: -10px; ">2)&nbsp;A flag indicating whether or not the seed has been set by the user. (_randSeedSet)</DIV>
<DIV style="margin-left: 10px; text-indent: -10px; ">3)&nbsp;The number of calls to the random number generator since the last data exchange. (_numRandCalls)</DIV>
<DIV style="margin-left: 10px; text-indent: -10px; ">4)&nbsp;The number generated by the last such call. (_lastRandVal)</DIV>
<DIV>&nbsp;</DIV>
<DIV>The slaves compare the transmitted values to their own using the following code:</DIV>
<DIV>&nbsp;</DIV>
<DIV><SPAN style="font-family: Courier New; ">&nbsp;  _randSynchError = 0;</SPAN></DIV>
<DIV><SPAN style="font-family: Courier New; ">&nbsp;  if (!_firstTransfer) {</SPAN></DIV>
<DIV><SPAN style="font-family: Courier New; ">&nbsp; &nbsp; &nbsp;  if (lastNumCalls != _numRandCalls)</SPAN></DIV>
<DIV><SPAN style="font-family: Courier New; ">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  _randSynchError |= 1;</SPAN></DIV>
<DIV><SPAN style="font-family: Courier New; ">&nbsp; &nbsp; &nbsp;  if ((lastSeed != _randomSeed)&amp;&amp;(!_randSeedSet))</SPAN></DIV>
<DIV><SPAN style="font-family: Courier New; ">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  _randSynchError |= 2;</SPAN></DIV>
<DIV><SPAN style="font-family: Courier New; ">&nbsp; &nbsp; &nbsp;  if (tempRandVal != _lastRandVal)</SPAN></DIV>
<DIV><SPAN style="font-family: Courier New; ">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  _randSynchError |= 4;</SPAN></DIV>
<DIV><SPAN style="font-family: Courier New; ">&nbsp;  } else</SPAN></DIV>
<DIV><SPAN style="font-family: Courier New; ">&nbsp; &nbsp; &nbsp;  _firstTransfer = 0;</SPAN></DIV>
<DIV><SPAN style="font-family: Courier New; ">&nbsp;  _numRandCalls = 0;</SPAN></DIV>
<DIV>&nbsp;</DIV>
<DIV>The next call to the random number generator checks _randSynchError and prints one or more error messages based on its value.</DIV>
<DIV>&nbsp;</DIV>
<DIV><B><U>Functions</B></U></DIV>
<DIV>&nbsp;</B></U></DIV>
<DIV><SPAN style="font-family: Courier New; ">void arMasterSlaveFramework::setRandomSeed( const long newSeed )</SPAN></DIV>
<DIV>&nbsp;</DIV>
<DIV>Sets the random seed on the master.&nbsp;  <I>The change does not take effect until immediately before the next data transfer</I>, so it's probably not a good idea to start generating random numbers in e.g. the framework's init() callback.&nbsp;  A value of 0 for the seed is illegal and will be converted to -1 with a printed warning.</DIV>
<DIV>&nbsp;</DIV>
<DIV><SPAN style="font-family: Courier New; ">bool arMasterSlaveFramework::randUniformFloat( float&amp; value )</SPAN></DIV>
<DIV>&nbsp;</DIV>
<DIV>Generates a new pseudo-random number using the <I>ran1 </I>algorithm from <I>Numerical Recipes in C</I>.&nbsp;  Note that this algorithm generates uniformly-distributed values in the range (0,1), i.e. it does not include either 0 or 1.&nbsp;  It returns a bool indicating whether or not _randSynchError is 0.&nbsp;  As side-effects, it (1) resets _randSynchError to 0, so there is&nbsp;  at most one error message per frame; (2) modifies the seed; (3) increments a counter, which is reset to 0 after each master/slave data transfer.</DIV>
<DIV>&nbsp;</DIV>
<DIV><B><U>Getting into trouble</B></U></DIV>
<DIV>&nbsp;</B></U></DIV>
<DIV>What follows is a list of conditions that we've thought of or come across under which the random number sequences will become desynchronized (mind you, the framework will tell you that you've gotten into trouble):</DIV>
<DIV>&nbsp;</DIV>
<DIV>(1) Calling randUniformFloat() in a way that depends on arMasterSlaveFramework::getMaster().&nbsp;  This function is designed to be used in exactly the same way on masters and slaves, so:</DIV>
<DIV>&nbsp;</DIV>
<DIV><SPAN style="font-family: Courier New; ">if (framework-&gt;getMaster())</SPAN></DIV>
<DIV><SPAN style="font-family: Courier New; ">&nbsp;  dorandomstuff()</SPAN></DIV>
<DIV>&nbsp;</DIV>
<DIV>is a Bad Thing.</DIV>
<DIV>&nbsp;</DIV>
<DIV>(2) Starting to call randUniformFloat() based on user input in the preExchange() callback.&nbsp;  At this point, user input is only available to the master.&nbsp;  For example:</DIV>
<DIV>&nbsp;</DIV>
<DIV><SPAN style="font-family: Courier New; ">preExchange() {</SPAN></DIV>
<DIV><SPAN style="font-family: Courier New; ">&nbsp;  if (framework-&gt;getButton(0))</SPAN></DIV>
<DIV><SPAN style="font-family: Courier New; ">&nbsp; &nbsp; &nbsp;  startRandom = true;</SPAN></DIV>
<DIV><SPAN style="font-family: Courier New; ">}</SPAN></DIV>
<DIV>&nbsp;</DIV>
<DIV><SPAN style="font-family: Courier New; ">postExchange() {</SPAN></DIV>
<DIV><SPAN style="font-family: Courier New; ">&nbsp;  if (startRandom)</SPAN></DIV>
<DIV><SPAN style="font-family: Courier New; ">&nbsp; &nbsp; &nbsp;  startusingrandomnumbers()</SPAN></DIV>
<DIV><SPAN style="font-family: Courier New; ">}</SPAN></DIV>
<DIV>&nbsp;</DIV>
<DIV>Is guaranteed to get you into trouble.&nbsp;  Either move the code in preExchange() to postExchange() or use the library function ar_randUniformFloat() to generate random numbers on the master for manual sharing with the slaves.</DIV>
<DIV>&nbsp;</DIV>
<DIV>(3) Calling randUniformFloat() in more than one concurrent thread.&nbsp;  Use ar_randUniformFloat() and share the generated data instead.</DIV>
<DIV>&nbsp;</DIV>
<DIV>(4) Calling randUniformFloat() before all program instances are running.&nbsp;  Because Syzygy is designed around the premise that no program instance should care whether or not other instances are running (provided there is a master instance somewhere), this can only be determined by the user.&nbsp;  The user should be required to indicate by e.g. a button press that all instances are running before randUniformFloat() is called.</DIV>
<DIV>&nbsp;</DIV>
<DIV>&nbsp;</DIV>
<DIV>&nbsp;</DIV>


</BODY></HTML>